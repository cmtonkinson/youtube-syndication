#!/usr/bin/env bash
set -u

fs=""
script=""
file=""
vars=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -F)
      fs="$2"
      shift 2
      ;;
    -F*)
      fs="${1#-F}"
      shift
      ;;
    -v)
      vars+=("$2")
      shift 2
      ;;
    *)
      if [[ -z "${script}" ]]; then
        script="$1"
      elif [[ -z "${file}" ]]; then
        file="$1"
      else
        file="$1"
      fi
      shift
      ;;
  esac
done

python3 - "${fs}" "${script}" "${file}" "${vars[@]}" <<'PY'
import sys, re

fs = sys.argv[1]
script = sys.argv[2]
file = sys.argv[3] if len(sys.argv) > 3 else ""
vars = sys.argv[4:]
var_map = {}
for var in vars:
    if "=" in var:
        k, v = var.split("=", 1)
        var_map[k] = v

if fs:
    data = sys.stdin.read().splitlines()
    sep = bytes(fs, "utf-8").decode("unicode_escape")
    target = var_map.get("id", "")
    found = False
    for line in data:
        parts = line.split(sep)
        if parts and parts[0] == target:
            if len(parts) >= 3:
                sys.stdout.write(parts[2])
            found = True
            break
    sys.exit(0 if found else 1)

if not file:
    sys.exit(0)

with open(file, "r", encoding="utf-8") as fh:
    lines = fh.read().splitlines()

def grab(line, key):
    match = re.search(r'"%s"\\s*:\\s*"([^"]*)"' % re.escape(key), line)
    return match.group(1) if match else ""

for line in lines:
    if '"id"' not in line:
        continue
    idv = grab(line, "id")
    if not idv:
        continue
    published = grab(line, "published_at")
    status = grab(line, "status")
    video_path = grab(line, "video_path")
    thumb_path = grab(line, "thumbnail_path")
    sys.stdout.write("\\t".join([idv, published, status, video_path, thumb_path]) + "\\n")
PY
